sudo: required

language: python
python: 2.7

services:
  - docker

env:
  matrix:
    - MONOLITHIC=True TOX_ENV=py27
    - COMPOSE_SLURM=True
    - COMPOSE_SLURM_SINGULARITY=True
    # Compose version with Condor submitting Docker jobs
    - COMPOSE_CONDOR_DOCKER=True
    - KUBE=True
  global:
    - secure: "SEjcKJQ0NGXdpFxFhLVlyJmiBvgiLtR5Uufg90Vm3owKlMy0NSfIrOR+2dwNniqOp7QI3eVepnqjid/Ka0QStzVqMCe55OLkJ/TbTHnMLpbtY63mpGfogVRvxMMAVpzLpcQqtJFORZmO/MIWSLlBiXMMzOg3+tbXvQXmL17Rbmw="

matrix:
  allow_failures:
    - env: KUBE=True

git:
  submodules: false

before_install:
  - export WORKING_DIR="$TRAVIS_BUILD_DIR"
  - bash .ci/setup.sh

  - git submodule update --init --recursive
  - sudo chown 1450 /tmp && sudo chmod a=rwx /tmp

  # Build and test the monolithic container
  - |
    if [ "${MONOLITHIC}" ]
    then
        bash .ci/monolithic.sh
    fi

  # Build and test the k8s compose containers
  - |
    if [ "${KUBE}" ]
    then
        bash .ci/kube.sh
    fi


  # Build and test the compose SLURM enabled containers
  - |
    if [ "${COMPOSE_SLURM}" ]
    then
        bash .ci/compose_slurm.sh
    fi

  # Build and test the compose SLURM enabled containers with Singularity dependency resolver
  - |
    if [ "${COMPOSE_SLURM_SINGULARITY}" ]
    then
        bash .ci/compose_slurm_singularity.sh
    fi

  # Build and test the compose ht-condor enabled containers with Docker dependency resolver
  - |
    if [ "${COMPOSE_CONDOR_DOCKER}" ]
    then
        bash .ci/compose_condor_docker.sh
    fi






script:


  # Check if the database image matches the current galaxy version
  - |
      if [ "${COMPOSE_SLURM}" ] || [ "${KUBE}" ] || [ "${COMPOSE_CONDOR_DOCKER}" ] || [ "${COMPOSE_SLURM_SINGULARITY}" ]
      then
        cd $WORKING_DIR && bash ./dumpsql.sh
        git diff --exit-code $WORKING_DIR/galaxy-postgres/init-galaxy-db.sql.in || ( echo "Database dump does not equal dump in repository" && false )
      fi


after_success:
  - |
    if [ "$TRAVIS_PULL_REQUEST" == "false" -a "$TRAVIS_BRANCH" == "master" ]
    then
      if [ ! "${COMPOSE_SLURM}" ] && [ ! "${KUBE}" ] && [ ! "${COMPOSE_CONDOR_DOCKER}" ] && [ ! "${COMPOSE_SLURM_SINGULARITY}" ]
      then
        cd ${TRAVIS_BUILD_DIR}
        echo "Generate and deploy html documentation"
        ./docs/bin/deploy_docs
      fi
    fi


notifications:
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/559f5480ac7a4ef238af
    on_success: change
    on_failure: always
    on_start: never
